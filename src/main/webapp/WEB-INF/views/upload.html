<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--<link rel="stylesheet" th:href="@{/upload.css}">-->
    <style>
        *{
            margin:0;
            padding: 0;
        }
        input,button,select{
            outline: none;
        }
        .uploadTitle {
            margin:0;
            padding: 20px 0px 20px 20px;
            background: #0a6aa1;
            color: white;
            font-size: 20px;
        }
        .uploadForm{
            box-sizing: border-box;
            margin: 20px 20px 20px 22px;
            width: 97%;
            height: 70px;
            line-height: 70px;
            background: #f2f2f2;
            padding-left: 30px;
        }
        .title{
            display: inline-block;
            font-size: 16px;
            margin-right: 30px;
        }
        .control-label{
            display: inline-block;
            margin-right: 10px;
            width: 70px;
        }
        .form-control{
            padding: 3px 8px;
            width: 210px;
        }
        .fileInput{
            box-sizing: border-box;
            width: 200px;
            background: white;
            padding-left: 4px;
        }
        .describe{
            /*border: 0;*/
            border: 1px solid #b0b0b0;
            height: 16px;
        }
        .select-control{
            width: 228px;
        }
        .submitBtn{
            width: 80px;
            height: 24px;
            background: #e59906;
            border: 0;
            color:white;
        }
        .uploadBtn,.closeBtn{
            width: 80px;
            height: 24px;
            background: #2d82e5;
            border: 0;
            color:white;
        }
        .tableWrap{
            border-collapse: collapse;
            border: 0;
            width: 97%;
            margin: 0 0 0 22px;
        }
        .tableWrap th{
            height: 30px;
            background: #f2f2f2;
            font-size: 14px;
            font-weight: 600;
        }
        .tableWrap td{
            height: 35px;
            text-align: center;
        }
        .downloadLink{
            margin-left: 10px;
            font-size: 14px;
            color: #0d8ddb;
            cursor: pointer;
        }
        .uploadFormLay{
            width: 400px;
            height: 190px;
            background: white;
            position: absolute;
            top:50%;
            left:50%;
            transform: translate(-50%,-50%);
            padding: 20px;
        }
        .mask{
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            top:0;
            left:0;
            display: none;
        }
        .selectItem{
            height: 35px;
        }
        .selectBtn{
            margin-top: 50px;
            box-sizing: border-box;
            padding-left: 100px;
        }
        .submitBtn{
            margin-right: 20px;
        }
    </style>
</head>
<body>
<h1 class="uploadTitle" th:inlines="text">数据文件上传</h1>
<div class="uploadForm">
    <div class="title">
        <input class="form-control describe"/>
    </div>
    <div class="title"><input class="submitBtn" type="button" value="搜&nbsp;索"/></div>
    <div class="title"><input class="uploadBtn" id="uploadBtn" type="button" value="上&nbsp;传"/></div>
</div>
<div class="mask" name="mask">
    <form class="uploadFormLay" th:action="@{/file/fileUpload}" method="post" enctype="multipart/form-data">
        <!--<input type="text" name="typeId" value="1" />-->
        <div class="selectItem">
            <label for="uploadForm" class="control-label">部门:</label>
            <select class="form-control select-control" name="deptId">
                <option>请选择部门</option>
                <option  th:each="depts:${depts}" th:value="${depts.id}" th:text="${depts.name }"></option>
            </select>
            <a class="downloadLink" name="downloadLink">下载模板</a>
        </div>

        <div class="selectItem"><span class="control-label">选择文件: </span><input class="fileInput" type="file" name="file"/></div>
        <!--<p>选择文件2: <input type="file" name="fileName"/></p>
        <p>选择文件3: <input type="file" name="fileName"/></p>-->
        <div class="selectItem">
            <label for="uploadForm" class="control-label" placeholder="">文件描述:</label>
            <input class="form-control describe" name="desc"/>
        </div>
        <div class="selectItem selectBtn">
            <input name="submitBtn" class="submitBtn" type="button" value="提&nbsp;交"/>
            <input name="closeBtn" class="closeBtn" type="button" value="关&nbsp;闭"/>
        </div>

    </form>
</div>

<div th:fragment="table_refresh" id="table_refresh">
    <table class="tableWrap" border="1">
        <tr>
            <th>序号</th>
            <th>文件名</th>
            <th>文件大小</th>
            <th>部门</th>
            <th>描述</th>
            <th>导入状态</th>
            <th>导入备注</th>
        </tr>
        <tr th:each="file,infoStat : ${files}">
            <td th:text="${infoStat.count}"></td>
            <td th:text="${file.name}"></td>
            <td th:text="${file.fileSize}+'k'"></td>
            <td th:text="${file.deptName}"></td>
            <td th:text="${file.fileDesc}"></td>
            <td>
                <div th:switch="${file.importStatus}">
                    <p th:case=1>正在导入</p>
                    <p th:case=2>数据格式不对</p>
                    <p th:case=3>已导入</p>
                    <p th:case=4>导入失败</p>
                    <p th:case="*"></p>
                </div>
            </td>
            <td th:text="${file.importDesc}"></td>
        </tr>
    </table>
</div>
    <script th:src="@{/jquery.min.js}"></script>
    <script th:src="@{/layer/layer.min.js}"></script>
    <script th:inline="javascript">
        $('#table_refresh').load([[@{/file/getFiles}]]);
        $('#uploadBtn').click(function () {
            $('[name="mask"]').show();
        });
        $('[name="closeBtn"]').click(function () {
            $('[name="mask"]').hide();
            //清空操作
            $('[name="deptId"]').val('请选择部门');
            $('[name="file"]').val('');
            $('[name="desc"]').val('');
        });
        $('[name="deptId"]').change(function (e) {
            var tid = $(e.target).val();
            //console.log(tid);
        });

        $('[name="submitBtn"]').click(function () {
            var formData = new FormData();
            var deptId = $('[name="deptId"]').val();
            var file = $('[name="file"]').get(0).files[0];
            var desc = $('[name="desc"]').val();
             console.log(deptId,desc,file);
            if(deptId&&file){
                formData.append("deptId",deptId);
                formData.append("file",file);
                formData.append("desc",desc);

                console.log(formData);
                unloadFormInit(formData);
            }else{
                alert('请填写必要信息')
            }

        });
        function unloadFormInit(dataP) {
            var url = [[@{/file/fileUpload}]];
            console.log(url);
            $.ajax({
                type: 'post',
                url: url,
                data:dataP,
                contentType: false, //不设置内容类型
                processData: false, //不处理数据
                success: function (data) {
                    console.log(data);
                    $('[name="mask"]').hide();
                }
            })
        }
    </script>
</body>
</html>